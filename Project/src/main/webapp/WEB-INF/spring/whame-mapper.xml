<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http:mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="whame">
	<insert id='enroll' parameterType="storevo">
 		insert into store(store_code, business_code, userid, operating_time, store_name, view_count)
 		values(store_seq.nextval, #{business_code}, #{userid}, #{operating_time}, #{store_name}, 0)
 	</insert>
 	
 	<insert id='setColor' parameterType="colorvo">
 		insert into store_color
 		values(#{store_code}, #{red}, #{blue}, #{green})
 	</insert>
 	
 	<insert id='setText' parameterType="textvo">
 		insert into store_text
 		values(#{store_code}, #{text})
 	</insert>
 	
 	<insert id='setMenu' parameterType="menuvo">
 		insert into menu
 		values(#{store_code}, #{menu_name}, #{menu_price}, #{menu_type})
 	</insert>
 	
 	<insert id='setLocation' parameterType="locationvo">
 		insert into store_location
 		values(#{store_code}, #{rcode}, #{lat}, #{lon}, #{address})
 	</insert>
 	
 	
 	
 	<!-- search -->
 	<!-- color+ocr -->
 	 <sql id="color_rate">
		where abs((red/#{color.red})-(blue/#{color.blue})) between 0 and 1
			or abs((red/#{color.red})-(green/#{color.green})) between 0 and 1
			or abs((green/#{color.green})-(blue/#{color.blue})) between 0 and 1 <!-- between 0 and 0.45 -->
	</sql>
	
	<!-- color -->
 	<sql id="color_max">
		where abs((red/#{color.red})-(blue/#{color.blue})) between 0 and 0.1
			or abs((red/#{color.red})-(green/#{color.green})) between 0 and 0.1 
			or abs((green/#{color.green})-(blue/#{color.blue})) between 0 and 0.1 <!-- between 0 and 0.45 -->
	</sql>
	
	<!-- 근방 Xm location -->
	<select id="searchLoc" resultType="int" parameterType="whamevo">
		select store_code
		from store_location
		where lat between #{lat}-#{difflat} and #{lat}+#{difflat}
		and lon between #{lon}-#{difflon} and #{lon}+#{difflon} 
	</select>
	
	<sql id="loc">
		select store_code
		from store_location
		where lat between #{lat}-#{difflat} and #{lat}+#{difflat}
		and lon between #{lon}-#{difflon} and #{lon}+#{difflon} 
	</sql>
	
	<!-- ocr search -->
 	<select id="searchText" resultType="int" parameterType="whamevo">
		select distinct(m.store_code), red, blue, green
		from 	(select distinct(s.store_code), sc.red, sc.blue, sc.green
				from store s, store_text st, store_color sc
				where s.store_code = st.store_code and sc.store_code = s.store_code
				and 
					<foreach collection="text" item="text" open="(" close=")" separator="or">
						<if test="text.text != null and text.text.length() >= 2">
						upper(st.text) like upper('%'||#{text.text}||'%')
						</if>
					</foreach>				
				) m
	 	 <include refid="color_rate" />
	 	 and m.store_code in (<include refid="loc" />)
	</select> 
	
	<!-- name search -->
	<select id="searchTextName" resultType="int" parameterType="whamevo">
		select distinct(m.store_code), red, blue, green
		from 	(select distinct(s.store_code), sc.red, sc.blue, sc.green
				from store s, store_text st, store_color sc
				where s.store_code = st.store_code and sc.store_code = s.store_code
				and 
					<foreach collection="text" item="text" open="(" close=")" separator="or">
						<if test="text.text != null and text.text.length() >= 2 ">
							upper(s.store_name) like upper('%'||#{text.text}||'%')
						</if>
					</foreach>				
				) m
	  	<include refid="color_rate" />  
	  	and m.store_code in (<include refid="loc" />)
	</select> 
	
	<!-- color search -->
	<select id="searchColor" resultType="int" parameterType="whamevo">
		select distinct(m.store_code), red, blue, green
		from 	(select distinct(s.store_code), sc.red, sc.blue, sc.green
				from store s, store_text st, store_color sc
				where s.store_code = st.store_code and sc.store_code = s.store_code
				) m
	  	<include refid="color_max" />  
	</select> 

	
	
	<!-- get -->
 	<select id='getstore_code' resultType="int" parameterType="String" >
 		select store_code from store where business_code= #{business_code}
 	</select> 
 	
 	<select id='getType' resultType="typevo"  >
 		select type_name, type_code from type
 	</select> 
 	
	<select id="getMenu" resultType="menuvo" parameterType="int">
		select * from menu where store_code = #{store_code}
	</select>
	
	<!-- get region -->
	<select id='rcodelist' resultType="regionvo" >
 		select * from region
 	</select> 
 	
 	<select id='getgu' resultType="regionvo" >
 		select * from region where length(rcode)=2
 	</select>
 	
 	<select id='getrcode' resultType="regionvo" parameterType="string">
 		select * from region where rname like #{gu}||'%'
 	</select>
 	
 	<select id='getrcodeNum' resultType="int" parameterType="string">
 		select rcode from region where rname = #{rname}
 	</select>
 	
 	<select id='getstore_info' resultType="storevo" parameterType="int">
 		select * from store where store_code = #{store_code}
 	</select>
 	
 	<select id='getlocation_info' resultType="locationvo" parameterType="int">
 		select * from store_location where store_code = #{store_code}
 	</select>
 	
 	<select id="getStore" resultType="storevo" parameterType="string">
 		select * from store where userid = #{userid}
 	</select>
 	
 	<select id="getStoreCount" resultType="int">
 		select count(*) from store
 	</select>
</mapper>